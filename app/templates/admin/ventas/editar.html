{% extends "base.html" %}

{% block title %}Editar Venta{% endblock %}

{% block content %}
<div class="container-fluid px-4 my-4">

    <!-- ==================== HEADER MEJORADO ==================== -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">
                <i class="fas fa-edit me-2"></i> Editar Venta #{{ venta.id }}
            </h2>
            <p class="text-muted mb-0">Modificar los detalles de la venta realizada el {{ venta.fecha.strftime("%d/%m/%Y a las %H:%M") }}</p>
        </div>
        
    </div>

    <div class="row">
        <!-- ==================== FORMULARIO EDITAR ==================== -->
        <div class="col-lg-8">
            <div class="card shadow-lg rounded-3 mb-4">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-pen me-2"></i> Modificar datos de la venta</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.editar_venta', venta_id=venta.id) }}">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Cliente -->
                                <div class="mb-3">
                                    <label for="cliente_id" class="form-label fw-semibold">Cliente</label>
                                    <select name="cliente_id" id="cliente_id" class="form-select" required>
                                        {% for cliente in clientes %}
                                            <option value="{{ cliente.id }}" {% if cliente.id == venta.cliente_id %}selected{% endif %}>
                                                {{ cliente.nombre }} ({{ cliente.correo }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Vendedor -->
                                <div class="mb-3">
                                    <label for="vendedor_id" class="form-label fw-semibold">Vendedor</label>
                                    <select name="vendedor_id" id="vendedor_id" class="form-select" required>
                                        {% for vendedor in vendedores %}
                                            <option value="{{ vendedor.id }}" {% if vendedor.id == venta.vendedor_id %}selected{% endif %}>
                                                {{ vendedor.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-semibold mb-0">Productos</label>
                                <button type="button" id="agregar-producto" class="btn btn-sm btn-outline-dark">
                                    <i class="fas fa-plus me-1"></i> Agregar producto
                                </button>
                            </div>
                            
                            <div id="productos-container">
                                {% for detalle in venta.detalles %}
                                <div class="card mb-2 producto-row">
                                    <div class="card-body py-2">
                                        <div class="row align-items-end">
                                            <div class="col-md-5">
                                                <label class="form-label small fw-bold">Producto</label>
                                                <select name="productos[{{ loop.index0 }}][id]" class="form-select" required>
                                                    <option value="">Seleccione un producto</option>
                                                    {% for producto in productos %}
                                                        <option value="{{ producto.id }}" data-precio="{{ producto.precio }}" {% if producto.id == detalle.producto_id %}selected{% endif %}>
                                                            {{ producto.nombre }} - ${{ "%.2f"|format(producto.precio) }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Cantidad</label>
                                                <input type="number" name="productos[{{ loop.index0 }}][cantidad]" class="form-control cantidad" min="1" value="{{ detalle.cantidad }}" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Precio Unitario</label>
                                                <input type="number" name="productos[{{ loop.index0 }}][precio_unitario]" class="form-control precio" step="0.01" value="{{ detalle.precio_unitario }}" required>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small fw-bold">Subtotal</label>
                                                <input type="text" class="form-control subtotal" readonly value="${{ "%.2f"|format(detalle.cantidad * detalle.precio_unitario) }}">
                                            </div>
                                            <div class="col-md-1 d-flex align-items-center justify-content-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger eliminar-producto">
                                                    <i class="fas fa-trash">Eliminar</i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Resumen de total -->
                        <div class="row mt-4">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                    <span class="fw-bold">TOTAL:</span>
                                    <span id="total-venta" class="fw-bold fs-5 text-success">${{ "%.2f"|format(venta.total) }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Botón de guardado -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin.ventas') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ==================== PANEL INFORMACIÓN ==================== -->
        <div class="col-lg-4">
            <div class="card shadow-sm rounded-3 mb-4">
                <div class="card-header bg-light py-3">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información de la Venta</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Fecha de creación</small>
                        <p class="mb-0">{{ venta.fecha.strftime("%d/%m/%Y a las %H:%M") }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Estado</small>
                        <p class="mb-0"><span class="badge bg-success">Completada</span></p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Vendedor asignado</small>
                        <p class="mb-0">{{ venta.vendedor.nombre }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Cliente</small>
                        <p class="mb-0">{{ venta.cliente.nombre }}</p>
                        <small class="text-muted">{{ venta.cliente.correo }}</small>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm rounded-3">
                <div class="card-header bg-light py-3">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recomendaciones</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info py-2">
                        <small>
                            <i class="fas fa-exclamation-circle me-1"></i> 
                            Al modificar cantidades o precios, el total se actualizará automáticamente.
                        </small>
                    </div>
                    <div class="alert alert-warning py-2">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i> 
                            Los cambios se guardarán inmediatamente al hacer clic en "Guardar Cambios".
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== JS PARA PRODUCTOS DINÁMICOS ==================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    let index = {{ venta.detalles|length }};
    const container = document.getElementById("productos-container");
    const btnAgregar = document.getElementById("agregar-producto");

    // Función para calcular subtotales y total
    function calcularTotales() {
        let totalVenta = 0;
        
        document.querySelectorAll(".producto-row").forEach(row => {
            const cantidad = parseFloat(row.querySelector(".cantidad").value) || 0;
            const precio = parseFloat(row.querySelector(".precio").value) || 0;
            const subtotal = cantidad * precio;
            
            row.querySelector(".subtotal").value = `$${subtotal.toFixed(2)}`;
            totalVenta += subtotal;
        });
        
        document.getElementById("total-venta").textContent = `$${totalVenta.toFixed(2)}`;
    }
    
    // Event listeners para cambios en cantidad y precio
    document.addEventListener("input", function(e) {
        if (e.target.classList.contains("cantidad") || e.target.classList.contains("precio")) {
            calcularTotales();
        }
    });
    
    // Event listener para cambio de producto (auto-completar precio)
    document.addEventListener("change", function(e) {
        if (e.target.tagName === "SELECT" && e.target.name.includes("productos")) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const precioInput = e.target.closest(".producto-row").querySelector(".precio");
            
            if (selectedOption && selectedOption.dataset.precio) {
                precioInput.value = selectedOption.dataset.precio;
                calcularTotales();
            }
        }
    });

    // Agregar nuevo producto
    btnAgregar.addEventListener("click", () => {
        const firstRow = document.querySelector(".producto-row");
        const newRow = firstRow.cloneNode(true);
        
        newRow.querySelectorAll("select, input").forEach(input => {
            const name = input.getAttribute("name");
            if (name) input.setAttribute("name", name.replace(/\[\d+\]/, `[${index}]`));
            if (input.tagName === "INPUT" && !input.classList.contains("subtotal")) {
                input.value = "";
            } else if (input.classList.contains("subtotal")) {
                input.value = "$0.00";
            }
            if (input.tagName === "SELECT") input.selectedIndex = 0;
        });
        
        newRow.querySelector(".eliminar-producto").addEventListener("click", function() {
            if (document.querySelectorAll(".producto-row").length > 1) {
                this.closest(".producto-row").remove();
                calcularTotales();
            }
        });
        
        container.appendChild(newRow);
        index++;
    });

    // Configurar eventos para eliminar productos existentes
    document.querySelectorAll(".eliminar-producto").forEach(btn => {
        btn.addEventListener("click", function() {
            if (document.querySelectorAll(".producto-row").length > 1) {
                this.closest(".producto-row").remove();
                calcularTotales();
            } else {
                alert("Debe haber al menos un producto en la venta.");
            }
        });
    });
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
.btn {
    border-radius: 0.35rem;
}
.form-select, .form-control {
    border-radius: 0.35rem;
}
.alert {
    border-radius: 0.5rem;
    border: none;
}
</style>
{% endblock %}